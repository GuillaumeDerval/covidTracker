{% extends "tpl.html" %}
{% block content %}

    <p class="is-size-4 subtitle">
        Fill this form to contribute. <a href="#">Everything is strictly anonymous</a>, don't worry!
    </p>

    <div id="error-message" class="notification is-danger {% if not errors %}is-hidden{% endif %}">
        {% for x in errors %}
            {{ x }}<br/>
        {% else %}
            {{ _("(no error... yet)") }}
        {% endfor %}
    </div>

    <form action="{{ url_for('multilingual.form') }}" method="post" name="main_form">
        <div class="field">
            <label for="sex" class="label">Sex</label>
            <div class="control">
                <div class="columns">
                    <div class="column">

                        <input class="is-checkradio is-block is-custom-checkradio-block" id="sex_male" type="radio"
                               name="sex" value="male" required>
                        <label for="sex_male">Male</label>
                    </div>
                    <div class="column">
                        <input class="is-checkradio is-block is-custom-checkradio-block" id="sex_female" type="radio"
                               name="sex" value="female" required>
                        <label for="sex_female">Female</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="field">
            <label for="age" class="label">Age</label>
            <div class="control">
                <div class="select is-primary">
                    <select name="age" id="age" required>
                        <option value="">{{ _("Select your age") }}</option>
                        {% for i in range(0, 125, 5) %}
                            <option value="{{ i }}">{{ i }} - {{ i + 4 }} years</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>
        <div class="field">
            <label for="status" class="label">How likely is it that you suffer(ed) from COVID-19?</label>
            {% set statuses = [('extremely_unlikely', _('Extremely unlikely')),
                                 ('unlikely', _("Unlikely (I had or still have very little symptoms)")),
                                 ('neutral', _("Maybe (I had or still have some symptoms)")),
                                 ('likely', _("Likely (I had or still have most symptoms)")),
                                 ('certain', _("Certain (confirmed by medical test)"))] %}
            <div class="control">
                <div class="columns">
                    {% for value, name in statuses %}
                        <div class="column">
                            <input class="is-checkradio is-block is-custom-checkradio-block"
                                   id="status_covid_{{ value }}" type="radio"
                                   name="status" value="{{ value }}" required>
                            <label for="status_covid_{{ value }}">{{ name }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div id="no-need-to-fill" class="notification is-primary is-hidden">
            Good news, you don't need to fill the fields below, as you were/are not sick! <br/>
            Simply submit the form at the bottom of the page.
        </div>
        <div class="field" id="when_sick_field">
            <label for="timing" class="label">When were you sick?</label>
            <div class="columns">
                <div class="column">
                    <label for="timing_covid" class="label">From</label>
                    <div class="control">
                        <input type="date" class="input is-primary" name="timing_from" id="timing_covid_from" value=""/>
                    </div>
                    <p class="help">Put the date where your first symptom appeared</p>
                </div>
                <div class="column">
                    <label for="timing_covid" class="label">To</label>
                    <div class="control">
                        <input type="date" class="input is-primary" name="timing_to" id="timing_covid_to" value=""/>
                    </div>
                    <p class="help">If you are still ill, please put any date in the future</p>
                </div>
            </div>
        </div>
        <div class="field" id="symptoms_field">
            <label for="symptoms" class="label">Which symptoms did you experience?</label>
            <div class="control">
                <div class="columns">
                    {% set symptoms = [('caugh', _('Dry Cough')),
                                 ('fever', _("Fever")),
                                 ('smell', _("Sudden loss of smell")),
                                 ('breathing', _("Breathing difficulties")),
                                 ('tiredness', _("Tiredness"))] %} {# TODO: finish the list #}
                    {% for value, name in symptoms %}
                        <div class="column">
                            <input class="is-checkradio is-block is-custom-checkradio-block"
                                   id="symptoms_{{ value }}" type="checkbox"
                                   name="symptoms_{{ value }}">
                            <label for="symptoms_{{ value }}">{{ name }}</label>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <div class="field">
            <div class="buttons is-centered" style="margin-top: 3em">
                <button type="submit" class="button is-primary is-large">Click here to continue</button>
            </div>
        </div>

    </form>

    <script type="text/javascript">
        /* Disable the datetime fields + symptoms if "very unlikely" is selected */
        function disable_or_enable_field(field, new_status) {
            var inputs = field.getElementsByTagName('input');
            for(var i = 0; i < inputs.length; i++)
                inputs[i].disabled = !new_status;
            if (new_status) {
                field.classList.remove("is-disabled");
            }
            else {
                field.classList.add("is-disabled");
            }
        }

        function radio_status_checked(radio) {
            if(radio.value === "extremely_unlikely") {
                disable_or_enable_field(document.getElementById("when_sick_field"), false);
                disable_or_enable_field(document.getElementById("symptoms_field"), false);
                document.getElementById("no-need-to-fill").classList.remove("is-hidden");
            }
            else {
                disable_or_enable_field(document.getElementById("when_sick_field"), true);
                disable_or_enable_field(document.getElementById("symptoms_field"), true);
                document.getElementById("no-need-to-fill").classList.add("is-hidden");
            }
        }

        var rad = document.main_form.status;
        var prev = null;
        for (var i = 0; i < rad.length; i++) {
            rad[i].addEventListener('change', function() {
                if(this.checked)
                    radio_status_checked(this);
            });
            if(rad[i].checked)
                radio_status_checked(rad[i]);
        }

        /* Checks content before authorizing the form to be submitted */
        function get_date(date_str) {
            if(RegExp('[0-9]{4}-[0-9]{2}-[0-9]{2}').test(date_str)) {
                return new Date(date_str);
            }
            else if(RegExp('[0-9]{1,2}/[0-9]{1,2}/[0-9]{2,4}').test(date_str)) {
                var splitted = date_str.split("/");
                var day = splitted[0];
                if(day.length === 1)
                    day = "0"+day;
                var month = splitted[1];
                if(month.length === 1)
                    month = "0"+month;
                var year = splitted[2];
                if(year.length === 2)
                    year = "20"+year;
                return new Date(year+"-"+month+"-"+day);
            }
            return null;
        }

        function display_warning(message) {
            var error_box = document.getElementById("error-message");
            error_box.classList.remove("is-hidden");
            error_box.textContent = message;
            error_box.scrollIntoView();
        }

        function validateForm() {
            var status = document.main_form.status.value;
            if (status !== "extremely_unlikely") {
                var from = get_date(document.getElementById("timing_covid_from").value);
                var to = get_date(document.getElementById("timing_covid_to").value);

                if(from === null || to === null) {
                    display_warning("{{ _('Invalid date format. Please enter it as dd/mm/yyyy, like 20/03/2019.') }}");
                    return false;
                }

                if(from > to) {
                    display_warning("{{ _('Invalid dates, you should fall ill before being cared.') }}");
                    return false;
                }

                var symptoms_checkbox_names = [
                    {% for value, name in symptoms %}
                        "symptoms_{{ value }}",
                    {% endfor %}
                ];
                var count = 0;
                for(var i = 0; i < symptoms_checkbox_names.length; i++) {
                    if(document.getElementById(symptoms_checkbox_names[i]).checked)
                        count += 1;
                }

                if(count == 0) {
                    display_warning("{{ _('If you think you are/were ill, please select the symptoms you faced. If you did not experience any of them, it is extremely unlikely you had covid-19.') }}");
                    return false;
                }

                return true;
            }
        }

        document.main_form.onsubmit = validateForm;
    </script>
{% endblock %}